#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "time.h"

// WiFi credentials
const char* ssid = "AKATSUKI";
const char* password = "2D6D629D";

// Firebase Realtime DB endpoint
const char* serverUrl = "https://inventorysystem-156d6-default-rtdb.firebaseio.com/sales.json";
const char* apiKey = "AIzaSyBzzfXvGm2bGm8ZWlZ6Ef28yB2zvzw9Kbc";  // Optional
const char* deviceId = "rice_dispenser_001";

// Timezone
const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = 28800;
const int daylightOffset_sec = 0;

// Variables
String saleTimestamp = "";

void setup() {
  Serial.begin(9600);

  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected to WiFi");

  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
  struct tm timeinfo;
  if (getLocalTime(&timeinfo)) {
    Serial.println("Time synced");
  } else {
    Serial.println("Time sync failed");
  }
}

void loop() {
  if (Serial.available()) {
    String data = Serial.readStringUntil('\n');
    data.trim();  // Remove any extra whitespace or newline characters

    // Check if data contains "KG:" and "PESO:"
    int kgIndex = data.indexOf("KG:");
    int pesoIndex = data.indexOf("PESO:");

    if (kgIndex != -1 && pesoIndex != -1) {
      String kgStr = data.substring(kgIndex + 3, pesoIndex - 1);
      String pesoStr = data.substring(pesoIndex + 5);

      float kg = kgStr.toFloat();
      float peso = pesoStr.toFloat();

      if (kg > 0 && peso > 0) {
        // Get current timestamp
        struct tm timeinfo;
        if (getLocalTime(&timeinfo)) {
          char timeBuffer[50];
          strftime(timeBuffer, sizeof(timeBuffer), "%Y-%m-%d %H:%M:%S", &timeinfo);
          saleTimestamp = String(timeBuffer);
        } else {
          saleTimestamp = String(millis());
        }

        Serial.print("Sending -> KG: ");
        Serial.print(kg);
        Serial.print(" Peso: ");
        Serial.println(peso);

        // Send data to Firebase
        sendSaleData(kg, peso);
      }
    }
  }

  delay(100);  // Delay to prevent excessive serial polling
}

void sendSaleData(float kg, float pesoAmount) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(serverUrl);  // Firebase URL
    http.addHeader("Content-Type", "application/json");

    if (strlen(apiKey) > 0) {
      http.addHeader("Authorization", "Bearer " + String(apiKey));  // Optional, if required
    }

    // Create a JSON object with sale data
    DynamicJsonDocument doc(1024);
    doc["weight"] = kg;
    doc["peso"] = pesoAmount;
    doc["timestamp"] = saleTimestamp;
    doc["device_id"] = deviceId;
    doc["status"] = "completed";

    String requestBody;
    serializeJson(doc, requestBody);

    // Send POST request to Firebase
    int responseCode = http.POST(requestBody);
    if (responseCode > 0) {
      String response = http.getString();
      Serial.println("POST Success: " + String(responseCode));
      Serial.println("Response: " + response);
    } else {
      Serial.print("POST Failed, Code: ");
      Serial.println(responseCode);
    }

    http.end();  // End HTTP connection
  } else {
    Serial.println("WiFi Disconnected. Reconnecting...");
    WiFi.begin(ssid, password);  // Reconnect to WiFi if disconnected
  }
}
